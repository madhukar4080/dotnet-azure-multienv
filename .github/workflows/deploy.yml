name: Build & Deploy .NET App (Dev / QA / UAT)

on:
  push:
    branches:
      - main

workflow_dispatch:      

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: src/SampleWebApp/SampleWebApp.csproj
  PUBLISH_DIR: publish

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        environment: [dev, qa, uat]

    environment: ${{ matrix.environment }}

    steps:
    # ----------------------------
    # Checkout
    # ----------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------------
    # Azure Login (Service Principal)
    # ----------------------------
    #- name: Login to Azure
    #  uses: azure/login@v2
    #  with:
    #    client-id: ${{ vars.AZURE_CLIENT_ID }}
    #    tenant-id: ${{ vars.AZURE_TENANT_ID }}
    #    subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    #    client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

    - name: Login to Azure
  uses: azure/login@v2
  with:
    creds: ${{ secrets.AZURE_CREDENTIALS }}
    

    # ----------------------------
    # Setup .NET
    # ----------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # ----------------------------
    # Restore
    # ----------------------------
    - name: Restore
      run: dotnet restore ${{ env.PROJECT_PATH }}

    # ----------------------------
    # Build
    # ----------------------------
    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    # ----------------------------
    # Publish
    # ----------------------------
    - name: Publish
      run: dotnet publish ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            --output ${{ env.PUBLISH_DIR }}

    # ----------------------------
    # Deploy using Azure CLI
    # ----------------------------
    - name: Deploy to Azure Web App
      run: |
        az webapp deploy \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
          --name ${{ vars.AZURE_WEBAPP_NAME }} \
          --src-path ${{ env.PUBLISH_DIR }} \
          --type zip

    # ----------------------------
    # App Settings (Environment + Secrets)
    # ----------------------------
    - name: Configure App Settings
      run: |
        az webapp config appsettings set \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
          --name ${{ vars.AZURE_WEBAPP_NAME }} \
          --settings \
            ASPNETCORE_ENVIRONMENT=${{ matrix.environment == 'dev' && 'Development' || matrix.environment == 'qa' && 'QA' || 'UAT' }} \
            MY_SECRET=${{ secrets.MY_SECRET }}
